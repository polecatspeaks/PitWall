<Window xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:PitWall.UI.ViewModels"
    xmlns:sp="using:ScottPlot.Avalonia"
    xmlns:controls="using:PitWall.UI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1920" d:DesignHeight="1080"
        x:Class="PitWall.UI.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="PitWall LMU - Professional Race Engineering System"
        WindowState="Maximized"
        MinWidth="1280"
        MinHeight="720">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*" Margin="0" RowSpacing="0">
        
        <!-- Status Bar - Always Visible -->
        <Border Grid.Row="0" Classes="panel" Margin="8,8,8,0" Padding="12">
            <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,*,Auto" ColumnSpacing="32">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Classes="data-label" Text="LAP" VerticalAlignment="Center" />
                    <TextBlock Classes="data-value" Text="{Binding CurrentLapDisplay}" FontSize="20" />
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" Spacing="8" Grid.Column="1">
                    <TextBlock Classes="data-label" Text="POS" VerticalAlignment="Center" />
                    <TextBlock Classes="data-value" Text="{Binding PositionDisplay}" FontSize="20" Foreground="{DynamicResource BrushInfo}" />
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" Spacing="8" Grid.Column="2">
                    <TextBlock Classes="data-label" Text="GAP" VerticalAlignment="Center" />
                    <TextBlock Classes="data-value" Text="{Binding GapDisplay}" FontSize="20" />
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" Spacing="8" Grid.Column="3">
                    <TextBlock Classes="data-label" Text="FUEL" VerticalAlignment="Center" />
                    <TextBlock Classes="data-value" Text="{Binding Dashboard.FuelLaps}" FontSize="20" Foreground="{DynamicResource BrushWarning}" />
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" Spacing="8" Grid.Column="4">
                    <TextBlock Classes="data-label" Text="NEXT PIT" VerticalAlignment="Center" />
                    <TextBlock Classes="data-value" Text="{Binding Strategy.NextPitLap, StringFormat='L{0}'}" FontSize="20" Foreground="{DynamicResource BrushInfo}" />
                </StackPanel>
                
                <Border Grid.Column="6" Background="{DynamicResource BrushCritical}" CornerRadius="4" Padding="12,4" 
                        HorizontalAlignment="Right" IsVisible="{Binding Dashboard.Alerts.Count}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="âš ï¸" FontSize="16" />
                        <TextBlock Text="{Binding Dashboard.Alerts.Count, StringFormat='{}{0} ALERTS'}" FontWeight="Bold" FontSize="13" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Main TabControl -->
        <TabControl Grid.Row="1" Margin="8" Classes="atlas-tabs" SelectedIndex="{Binding SelectedTabIndex}">
            
            <!-- Tab 1: Dashboard -->
            <TabItem Header="ðŸ“Š DASHBOARD">
                <ScrollViewer>
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*" RowSpacing="16" Margin="16">
                        
                        <!-- Row 1: Primary Panels (Fuel, Tires, Strategy, Timing) -->
                        <Grid Grid.Row="0" ColumnDefinitions="1*,1*,1*,1*" ColumnSpacing="16">
                            
                            <!-- Fuel Panel -->
                            <Border Classes="atlas-panel" Grid.Column="0">
                                <StackPanel Spacing="12">
                                    <TextBlock Classes="section-header" Text="FUEL" />
                                    <TextBlock Classes="data-value" Text="{Binding Dashboard.FuelLiters}" Foreground="{DynamicResource BrushWarning}" />
                                    <TextBlock Classes="label" Text="{Binding Dashboard.FuelLaps}" FontSize="14" />
                                    <ProgressBar Classes="atlas-progress" Value="{Binding Dashboard.FuelPercentage}" Maximum="100" 
                                                Foreground="{DynamicResource BrushWarning}" Height="12" />
                                    <TextBlock Classes="data-label" Text="{Binding Dashboard.FuelConsumptionRate, StringFormat='Consumption: {0}'}" />
                                </StackPanel>
                            </Border>

                            <!-- Tires Panel -->
                            <Border Classes="atlas-panel" Grid.Column="1">
                                <StackPanel Spacing="12">
                                    <TextBlock Classes="section-header" Text="TIRES" />
                                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" RowSpacing="8" ColumnSpacing="16">
                                        <!-- Front Left -->
                                        <StackPanel Grid.Row="0" Grid.Column="0" Spacing="4">
                                            <TextBlock Text="FL" Classes="data-label" />
                                            <TextBlock Text="{Binding Dashboard.TireFLTemp, StringFormat={}{0:0}Â°C}" FontSize="18" FontWeight="Bold" />
                                            <TextBlock Text="{Binding Dashboard.TireFLWear, StringFormat={}{0:0}%}" FontSize="14" />
                                        </StackPanel>
                                        <!-- Front Right -->
                                        <StackPanel Grid.Row="0" Grid.Column="1" Spacing="4">
                                            <TextBlock Text="FR" Classes="data-label" />
                                            <TextBlock Text="{Binding Dashboard.TireFRTemp, StringFormat={}{0:0}Â°C}" FontSize="18" FontWeight="Bold" />
                                            <TextBlock Text="{Binding Dashboard.TireFRWear, StringFormat={}{0:0}%}" FontSize="14" />
                                        </StackPanel>
                                        <!-- Rear Left -->
                                        <StackPanel Grid.Row="1" Grid.Column="0" Spacing="4">
                                            <TextBlock Text="RL" Classes="data-label" />
                                            <TextBlock Text="{Binding Dashboard.TireRLTemp, StringFormat={}{0:0}Â°C}" FontSize="18" FontWeight="Bold" />
                                            <TextBlock Text="{Binding Dashboard.TireRLWear, StringFormat={}{0:0}%}" FontSize="14" />
                                        </StackPanel>
                                        <!-- Rear Right -->
                                        <StackPanel Grid.Row="1" Grid.Column="1" Spacing="4">
                                            <TextBlock Text="RR" Classes="data-label" />
                                            <TextBlock Text="{Binding Dashboard.TireRRTemp, StringFormat={}{0:0}Â°C}" FontSize="18" FontWeight="Bold" />
                                            <TextBlock Text="{Binding Dashboard.TireRRWear, StringFormat={}{0:0}%}" FontSize="14" />
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Strategy Panel -->
                            <Border Classes="atlas-panel" Grid.Column="2">
                                <StackPanel Spacing="12">
                                    <TextBlock Classes="section-header" Text="STRATEGY" />
                                    <TextBlock Classes="data-value" Text="{Binding Dashboard.StrategyMessage}" TextWrapping="Wrap" FontSize="16" />
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Classes="label" Text="Confidence:" />
                                        <TextBlock Text="{Binding Dashboard.StrategyConfidence, StringFormat={}{0:P0}}" FontWeight="Bold" FontSize="14" />
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Classes="label" Text="Next Pit:" />
                                        <TextBlock Text="{Binding Strategy.NextPitLap, StringFormat={}Lap {0}}" FontWeight="Bold" FontSize="14" 
                                                  Foreground="{DynamicResource BrushInfo}" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Timing Panel -->
                            <Border Classes="atlas-panel" Grid.Column="3">
                                <StackPanel Spacing="12">
                                    <TextBlock Classes="section-header" Text="TIMING" />
                                    <StackPanel Spacing="6">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="LAST" Width="60" />
                                            <TextBlock Text="{Binding Dashboard.LastLapTime}" FontSize="16" FontFamily="Cascadia Mono, Consolas" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="BEST" Width="60" />
                                            <TextBlock Text="{Binding Dashboard.BestLapTime}" FontSize="16" FontFamily="Cascadia Mono, Consolas" 
                                                      Foreground="{DynamicResource BrushSuccess}" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="DELTA" Width="60" />
                                            <TextBlock Text="{Binding Dashboard.LapTimeDelta}" FontSize="16" FontFamily="Cascadia Mono, Consolas" />
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </Grid>

                        <!-- Row 2: Weather, Mini Telemetry, Track Map -->
                        <Grid Grid.Row="1" ColumnDefinitions="1*,1*,1*" ColumnSpacing="16">
                            
                            <!-- Weather Panel -->
                            <Border Classes="atlas-panel" Grid.Column="0">
                                <StackPanel Spacing="12">
                                    <TextBlock Classes="section-header" Text="WEATHER &amp; TRACK" />
                                    <StackPanel Spacing="6">
                                        <TextBlock Text="{Binding Dashboard.WeatherConditions}" FontSize="18" FontWeight="Bold" />
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="Track Temp:" />
                                            <TextBlock Text="{Binding Dashboard.TrackTempC, StringFormat={}{0}Â°C}" FontSize="14" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="Grip:" />
                                            <TextBlock Text="{Binding Dashboard.GripPercentage, StringFormat={}{0:0}%}" FontSize="14" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="Car:" />
                                            <TextBlock Text="{Binding Dashboard.CarName}" FontSize="14" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="Class:" />
                                            <TextBlock Text="{Binding Dashboard.CarClass}" FontSize="14" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="Power:" />
                                            <TextBlock Text="{Binding Dashboard.CarPower}" FontSize="14" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="Weight:" />
                                            <TextBlock Text="{Binding Dashboard.CarWeight}" FontSize="14" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="label" Text="Dims:" />
                                            <TextBlock Text="{Binding Dashboard.CarDimensions}" FontSize="14" />
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Mini Telemetry -->
                            <Border Classes="atlas-panel" Grid.Column="1">
                                <StackPanel Spacing="12">
                                    <TextBlock Classes="section-header" Text="MINI TELEMETRY" />
                                    <StackPanel Spacing="8">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Classes="data-label" Text="SPEED" Width="70" />
                                            <TextBlock Text="{Binding Dashboard.SpeedDisplay}" FontSize="18" FontWeight="Bold" />
                                        </StackPanel>
                                        <StackPanel Spacing="4">
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                <ProgressBar Grid.Column="0" Classes="atlas-progress" Value="{Binding Dashboard.ThrottlePercent}" Maximum="100" Height="10" />
                                                <TextBlock Grid.Column="1" Text="{Binding Dashboard.ThrottleDisplay}" FontSize="12" VerticalAlignment="Center" />
                                            </Grid>
                                            <TextBlock Classes="data-label" Text="THROTTLE" FontSize="11" />
                                        </StackPanel>
                                        <StackPanel Spacing="4">
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                <ProgressBar Grid.Column="0" Classes="atlas-progress" Value="{Binding Dashboard.BrakePercent}" Maximum="100" Height="10" Foreground="{DynamicResource BrushCritical}" />
                                                <TextBlock Grid.Column="1" Text="{Binding Dashboard.BrakeDisplay}" FontSize="12" VerticalAlignment="Center" />
                                            </Grid>
                                            <TextBlock Classes="data-label" Text="BRAKE" FontSize="11" />
                                        </StackPanel>
                                        <StackPanel Spacing="4">
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                <ProgressBar Grid.Column="0" Classes="atlas-progress" Value="{Binding Dashboard.SteeringPercent}" Maximum="100" Height="10" Foreground="{DynamicResource BrushInfo}" />
                                                <TextBlock Grid.Column="1" Text="{Binding Dashboard.SteeringDisplay}" FontSize="12" VerticalAlignment="Center" />
                                            </Grid>
                                            <TextBlock Classes="data-label" Text="STEERING" FontSize="11" />
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Track Map -->
                            <Border Classes="atlas-panel" Grid.Column="2">
                                <StackPanel Spacing="10">
                                    <TextBlock Classes="section-header" Text="TRACK MAP" />
                                    <controls:TrackMapControl Height="180" TrackPoints="{Binding TrackMap.TrackPoints}" CurrentPoint="{Binding TrackMap.CurrentPoint}" />
                                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                                        <StackPanel Grid.Column="0" Spacing="4">
                                            <TextBlock Classes="data-label" Text="SECTOR" />
                                            <TextBlock Text="{Binding TrackMap.SectorLabel}" FontWeight="Bold" FontSize="14" />
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Spacing="4">
                                            <TextBlock Classes="data-label" Text="CORNER" />
                                            <TextBlock Text="{Binding TrackMap.CornerLabel}" FontWeight="Bold" FontSize="14" />
                                        </StackPanel>
                                    </Grid>
                                    <TextBlock Text="{Binding TrackMap.TrackName}" FontSize="12" Foreground="{DynamicResource BrushTextSecondary}" />
                                </StackPanel>
                            </Border>
                        </Grid>

                        <!-- Row 3: Relative Position and Standings -->
                        <Grid Grid.Row="2" ColumnDefinitions="1*,2*" ColumnSpacing="16">
                            <Border Classes="atlas-panel" Grid.Column="0">
                                <StackPanel Spacing="10">
                                    <TextBlock Classes="section-header" Text="RELATIVE POSITION" />
                                    <ItemsControl ItemsSource="{Binding Dashboard.RelativePositions}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="#0D0D0D" Padding="8" Margin="0,4" CornerRadius="4" BorderBrush="#2A2A2A" BorderThickness="1">
                                                    <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto" ColumnSpacing="8">
                                                        <TextBlock Grid.Column="0" Text="{Binding Relation}" FontWeight="Bold" />
                                                        <TextBlock Grid.Column="1" Text="{Binding Position, StringFormat='P{0}'}" />
                                                        <TextBlock Grid.Column="2" Text="{Binding CarNumber, StringFormat='#{0}'}" />
                                                        <TextBlock Grid.Column="3" Text="{Binding Driver}" />
                                                        <TextBlock Grid.Column="4" Text="{Binding Gap}" HorizontalAlignment="Right" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>

                            <Border Classes="atlas-panel" Grid.Column="1">
                                <Grid RowDefinitions="Auto,*">
                                    <TextBlock Grid.Row="0" Classes="section-header" Text="RACE STANDINGS" Margin="8,8,8,12" />
                                    <DataGrid Grid.Row="1" ItemsSource="{Binding Dashboard.Standings}" 
                                             AutoGenerateColumns="False" IsReadOnly="True" 
                                             GridLinesVisibility="Horizontal" Background="#0D0D0D" 
                                             HeadersVisibility="Column" CanUserReorderColumns="False"
                                             CanUserResizeColumns="True" CanUserSortColumns="True"
                                             MaxHeight="220" Margin="8,0,8,8">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Pos" Binding="{Binding Position}" Width="60" />
                                            <DataGridTextColumn Header="Class" Binding="{Binding Class}" Width="90" />
                                            <DataGridTextColumn Header="Car #" Binding="{Binding CarNumber}" Width="85" />
                                            <DataGridTextColumn Header="Driver" Binding="{Binding Driver}" Width="*" />
                                            <DataGridTextColumn Header="Gap" Binding="{Binding Gap}" Width="90" />
                                            <DataGridTextColumn Header="Laps" Binding="{Binding Laps}" Width="70" />
                                        </DataGrid.Columns>
                                    </DataGrid>
                                </Grid>
                            </Border>
                        </Grid>

                        <!-- Row 4: Alerts -->
                        <Border Grid.Row="3" Classes="atlas-panel" IsVisible="{Binding Dashboard.Alerts.Count}">
                            <StackPanel Spacing="8">
                                <TextBlock Classes="section-header" Text="âš ï¸ ALERTS" />
                                <ItemsControl ItemsSource="{Binding Dashboard.Alerts}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" FontSize="14" Margin="0,4" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- Tab 2: Telemetry Analysis -->
            <TabItem Header="ðŸ“ˆ TELEMETRY">
                <Grid RowDefinitions="Auto,*,Auto" Margin="16" RowSpacing="16">
                    
                    <!-- Header with Controls -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="16">
                            <TextBlock Classes="section-header" Text="TELEMETRY ANALYSIS" VerticalAlignment="Center" />
                            <Border Background="#1A1A2E" CornerRadius="4" Padding="8,2" VerticalAlignment="Center">
                                <TextBlock Text="{Binding TelemetryAnalysis.LapDisplay}" FontSize="14" FontWeight="Bold"
                                          Foreground="#00D9FF" VerticalAlignment="Center" />
                            </Border>
                            <TextBlock Text="{Binding TelemetryAnalysis.StatusMessage}" FontSize="12" 
                                      Foreground="{DynamicResource BrushTextSecondary}" VerticalAlignment="Center" />
                            <TextBlock Text="{Binding TelemetryAnalysis.SectorLabel}" FontSize="12"
                                      Foreground="{DynamicResource BrushInfo}" VerticalAlignment="Center" />
                            <TextBlock Text="{Binding TelemetryAnalysis.CornerLabel}" FontSize="12"
                                      Foreground="{DynamicResource BrushWarning}" VerticalAlignment="Center" />
                        </StackPanel>
                        
                        <!-- Lap Selector and Controls -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                            <Button Content="â—€ Prev Lap" Command="{Binding TelemetryAnalysis.PreviousLapCommand}" Padding="8,4" />
                            <Button Content="Next Lap â–¶" Command="{Binding TelemetryAnalysis.NextLapCommand}" Padding="8,4" />
                            <Button Content="Zoom In" Command="{Binding TelemetryAnalysis.ZoomInCommand}" Padding="8,4" />
                            <Button Content="Zoom Out" Command="{Binding TelemetryAnalysis.ZoomOutCommand}" Padding="8,4" />
                            <Button Content="Export CSV" Classes="atlas-button-primary" 
                                   Command="{Binding TelemetryAnalysis.ExportToCsvCommand}" Padding="8,4" />
                        </StackPanel>
                    </Grid>

                    <!-- Plots and Replay Controls -->
                    <Grid Grid.Row="1" ColumnDefinitions="3*,Auto,1.2*" ColumnSpacing="0">
                        <Grid Grid.Column="0" RowDefinitions="*,Auto" RowSpacing="16">
                            <!-- Waveform Plots Placeholder -->
                            <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
                                <StackPanel Spacing="12">
                                    <!-- Speed Plot -->
                                    <Border Classes="atlas-panel" Height="140">
                                        <Grid RowDefinitions="Auto,*">
                                            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="8">
                                                <TextBlock Text="SPEED" FontWeight="Bold" FontSize="12" />
                                                <TextBlock Text="(km/h)" FontSize="11" Foreground="{DynamicResource BrushTextSecondary}" />
                                            </StackPanel>
                                            <Border Grid.Row="1" Background="#0D0D0D" Margin="8,0,8,8">
                                                <sp:AvaPlot x:Name="SpeedPlot" />
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <!-- Throttle Plot -->
                                    <Border Classes="atlas-panel" Height="140">
                                        <Grid RowDefinitions="Auto,*">
                                            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="8">
                                                <TextBlock Text="THROTTLE" FontWeight="Bold" FontSize="12" />
                                                <TextBlock Text="(%)" FontSize="11" Foreground="{DynamicResource BrushTextSecondary}" />
                                            </StackPanel>
                                            <Border Grid.Row="1" Background="#0D0D0D" Margin="8,0,8,8">
                                                <sp:AvaPlot x:Name="ThrottlePlot" />
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <!-- Brake Plot -->
                                    <Border Classes="atlas-panel" Height="140">
                                        <Grid RowDefinitions="Auto,*">
                                            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="8">
                                                <TextBlock Text="BRAKE" FontWeight="Bold" FontSize="12" />
                                                <TextBlock Text="(%)" FontSize="11" Foreground="{DynamicResource BrushTextSecondary}" />
                                            </StackPanel>
                                            <Border Grid.Row="1" Background="#0D0D0D" Margin="8,0,8,8">
                                                <sp:AvaPlot x:Name="BrakePlot" />
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <!-- Steering Plot -->
                                    <Border Classes="atlas-panel" Height="140">
                                        <Grid RowDefinitions="Auto,*">
                                            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="8">
                                                <TextBlock Text="STEERING" FontWeight="Bold" FontSize="12" />
                                                <TextBlock Text="(degrees)" FontSize="11" Foreground="{DynamicResource BrushTextSecondary}" />
                                            </StackPanel>
                                            <Border Grid.Row="1" Background="#0D0D0D" Margin="8,0,8,8">
                                                <sp:AvaPlot x:Name="SteeringPlot" />
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <!-- Tire Temperature Plot -->
                                    <Border Classes="atlas-panel" Height="140">
                                        <Grid RowDefinitions="Auto,*">
                                            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="8">
                                                <TextBlock Text="TIRE TEMPERATURE" FontWeight="Bold" FontSize="12" />
                                                <TextBlock Text="(Â°C average)" FontSize="11" Foreground="{DynamicResource BrushTextSecondary}" />
                                            </StackPanel>
                                            <Border Grid.Row="1" Background="#0D0D0D" Margin="8,0,8,8">
                                                <sp:AvaPlot x:Name="TireTempPlot" />
                                            </Border>
                                        </Grid>
                                    </Border>
                                </StackPanel>
                            </ScrollViewer>

                            <!-- Cursor Data Table -->
                            <Border Grid.Row="1" Classes="atlas-panel" MinHeight="180">
                                <StackPanel Spacing="2">
                                    <TextBlock Classes="section-header" Text="CURSOR DATA" Margin="0,0,0,6" />
                                    <!-- Header row -->
                                    <Grid ColumnDefinitions="130,120,50" Background="#111111" Margin="0,0,0,2">
                                        <TextBlock Grid.Column="0" Text="Parameter" FontSize="11" FontWeight="Bold" Foreground="{DynamicResource BrushTextSecondary}" Margin="4,3" />
                                        <TextBlock Grid.Column="1" Text="Current" FontSize="11" FontWeight="Bold" Foreground="{DynamicResource BrushTextSecondary}" Margin="4,3" />
                                        <TextBlock Grid.Column="2" Text="Unit" FontSize="11" FontWeight="Bold" Foreground="{DynamicResource BrushTextSecondary}" Margin="4,3" />
                                    </Grid>
                                    <!-- Data rows -->
                                    <ItemsControl ItemsSource="{Binding TelemetryAnalysis.CursorData}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid ColumnDefinitions="130,120,50" Margin="0,1">
                                                    <TextBlock Grid.Column="0" Text="{Binding Parameter}" FontSize="12" Foreground="{DynamicResource BrushInfo}" FontFamily="Cascadia Mono, Consolas, Menlo" Margin="4,2" />
                                                    <TextBlock Grid.Column="1" Text="{Binding CurrentValue}" FontSize="12" Foreground="White" FontFamily="Cascadia Mono, Consolas, Menlo" Margin="4,2" />
                                                    <TextBlock Grid.Column="2" Text="{Binding Unit}" FontSize="11" Foreground="{DynamicResource BrushTextSecondary}" Margin="4,2" />
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </Grid>

                        <!-- Resizable Splitter -->
                        <GridSplitter Grid.Column="1" Width="6" Background="#333333"
                                      ResizeDirection="Columns" ResizeBehavior="PreviousAndNext"
                                      Cursor="SizeWestEast" />

                        <!-- Track Map + Replay Controls (resizable vertically) -->
                        <Grid Grid.Column="2" RowDefinitions="3*,Auto,2*" MinWidth="280" MaxWidth="700">
                            <!-- Track Map (fills available vertical space) -->
                            <Border Grid.Row="0" Classes="atlas-panel">
                                <Grid RowDefinitions="*,Auto">
                                    <controls:TrackMapControl Grid.Row="0" MinHeight="150"
                                        TrackPoints="{Binding TrackMap.TrackPoints}" CurrentPoint="{Binding TrackMap.CurrentPoint}"
                                        CornerLabel="{Binding TrackMap.CornerLabel}" />
                                    <Grid Grid.Row="1" ColumnDefinitions="*,*" ColumnSpacing="4" Margin="0,4,0,0">
                                        <StackPanel Grid.Column="0" Spacing="1">
                                            <TextBlock Classes="data-label" Text="SECTOR" FontSize="10" />
                                            <TextBlock Text="{Binding TelemetryAnalysis.SectorLabel}" FontWeight="Bold" FontSize="12" />
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Spacing="1">
                                            <TextBlock Classes="data-label" Text="CORNER" FontSize="10" />
                                            <TextBlock Text="{Binding TelemetryAnalysis.CornerLabel}" FontWeight="Bold" FontSize="12" />
                                        </StackPanel>
                                    </Grid>
                                </Grid>
                            </Border>

                            <!-- Vertical Splitter -->
                            <GridSplitter Grid.Row="1" Height="6" Background="#333333"
                                          ResizeDirection="Rows" ResizeBehavior="PreviousAndNext"
                                          Cursor="SizeNorthSouth" />

                            <!-- Compact Replay Controls (scrollable) -->
                            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                            <Border Classes="atlas-panel" Padding="8">
                                <StackPanel Spacing="4">
                                    <!-- Session selector + play controls -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="4">
                                        <ComboBox Grid.Column="0" ItemsSource="{Binding FilteredSessions}"
                                                 SelectedItem="{Binding SelectedSession}"
                                                 DisplayMemberBinding="{Binding DisplayName}" FontSize="11" MinHeight="28" />
                                        <Button Grid.Column="1" Content="â†»" Command="{Binding LoadSessionsCommand}" Padding="6,2" FontSize="11" MinHeight="28" ToolTip.Tip="Refresh sessions" />
                                    </Grid>

                                    <!-- Transport buttons -->
                                    <StackPanel Orientation="Horizontal" Spacing="4" IsEnabled="{Binding ReplayEnabled}">
                                        <Button Content="â–¶" Command="{Binding PlayReplayCommand}" Padding="8,4" FontSize="14" ToolTip.Tip="Play" />
                                        <Button Content="â¸" Command="{Binding PauseReplayCommand}" Padding="8,4" FontSize="14" ToolTip.Tip="Pause" />
                                        <Button Content="â¹" Command="{Binding StopReplayCommand}" Padding="8,4" FontSize="14" ToolTip.Tip="Stop" />
                                        <Button Content="â®" Command="{Binding RestartReplayCommand}" Padding="8,4" FontSize="14" ToolTip.Tip="Restart" />
                                        <Button Content="âª" Command="{Binding RewindCommand}" Padding="8,4" FontSize="14" ToolTip.Tip="Rewind" />
                                        <Button Content="â©" Command="{Binding FastForwardCommand}" Padding="8,4" FontSize="14" ToolTip.Tip="Fast Forward" />
                                    </StackPanel>

                                    <!-- Status bar -->
                                    <Border Background="#111111" CornerRadius="4" Padding="6,4">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <TextBlock Text="{Binding TelemetryAnalysis.LapDisplay}" FontSize="11" FontWeight="Bold"
                                                      Foreground="#00D9FF" VerticalAlignment="Center" Margin="0,0,8,0" />
                                            <TextBlock Grid.Column="1" Text="{Binding ReplayStatusMessage}" FontSize="10" Foreground="{DynamicResource BrushTextSecondary}" VerticalAlignment="Center" />
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding ReplayProgressPercent, StringFormat='{}{0:0}%'}" FontSize="10" Foreground="{DynamicResource BrushTextSecondary}" />
                                                <TextBlock Text="{Binding ReplaySpeed, StringFormat='{}x{0:0.##}'}" FontSize="10" Foreground="{DynamicResource BrushTextSecondary}" />
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                    <ProgressBar Classes="atlas-progress" Height="4" Value="{Binding ReplayProgressPercent}" Maximum="100" />

                                    <!-- Advanced (collapsed by default) -->
                                    <Expander Header="Advanced" FontSize="10" Padding="0" IsExpanded="False">
                                        <StackPanel Spacing="3" Margin="0,4,0,0">
                                            <CheckBox Content="Enable Replay" IsChecked="{Binding ReplayEnabled}" FontSize="10" />
                                            <Grid ColumnDefinitions="*,*" ColumnSpacing="4">
                                                <TextBox Grid.Column="0" Watermark="Start" Text="{Binding ReplayStartRow, Mode=TwoWay}" FontSize="10" MinHeight="24" />
                                                <TextBox Grid.Column="1" Watermark="End" Text="{Binding ReplayEndRow, Mode=TwoWay}" FontSize="10" MinHeight="24" />
                                            </Grid>
                                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="4">
                                                <TextBlock Text="Int(ms)" FontSize="10" VerticalAlignment="Center" />
                                                <ComboBox Grid.Column="1" ItemsSource="{Binding ReplayIntervalsMs}" 
                                                         SelectedItem="{Binding ReplayIntervalMs}" FontSize="10" MinHeight="28" />
                                            </Grid>
                                            <StackPanel Orientation="Horizontal" Spacing="3">
                                                <Button Content=".5x" Command="{Binding HalfSpeedForwardCommand}" Padding="4,2" FontSize="10" />
                                                <Button Content=".25x" Command="{Binding QuarterSpeedForwardCommand}" Padding="4,2" FontSize="10" />
                                                <Button Content="-.5x" Command="{Binding HalfSpeedReverseCommand}" Padding="4,2" FontSize="10" />
                                                <Button Content="-.25x" Command="{Binding QuarterSpeedReverseCommand}" Padding="4,2" FontSize="10" />
                                                <Button Content="Apply" Command="{Binding ApplyReplaySettingsCommand}" Padding="4,2" FontSize="10" />
                                            </StackPanel>
                                            <!-- Filters -->
                                            <Expander Header="Filters" FontSize="10" Padding="0" IsExpanded="False">
                                                <StackPanel Spacing="3" Margin="0,4,0,0">
                                                    <Grid ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="4">
                                                        <TextBlock Text="From" FontSize="10" VerticalAlignment="Center" />
                                                        <DatePicker Grid.Column="1" SelectedDate="{Binding SessionFilterFrom}" />
                                                        <TextBlock Grid.Column="2" Text="To" FontSize="10" VerticalAlignment="Center" />
                                                        <DatePicker Grid.Column="3" SelectedDate="{Binding SessionFilterTo}" />
                                                    </Grid>
                                                    <Grid ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="4">
                                                        <TextBlock Text="Track" FontSize="10" VerticalAlignment="Center" />
                                                        <TextBox Grid.Column="1" Text="{Binding SessionFilterTrack, Mode=TwoWay}" Watermark="Any" FontSize="10" MinHeight="24" />
                                                        <TextBlock Grid.Column="2" Text="Car" FontSize="10" VerticalAlignment="Center" />
                                                        <TextBox Grid.Column="3" Text="{Binding SessionFilterCar, Mode=TwoWay}" Watermark="Any" FontSize="10" MinHeight="24" />
                                                    </Grid>
                                                </StackPanel>
                                            </Expander>
                                            <!-- Metadata -->
                                            <Expander Header="Metadata" FontSize="10" Padding="0" IsExpanded="False">
                                                <StackPanel Spacing="3" Margin="0,4,0,0">
                                                    <Grid ColumnDefinitions="Auto,*,Auto,*" ColumnSpacing="4">
                                                        <TextBlock Text="Track" FontSize="10" VerticalAlignment="Center" />
                                                        <TextBox Grid.Column="1" Text="{Binding SessionMetadataTrack, Mode=TwoWay}" FontSize="10" MinHeight="24" />
                                                        <TextBlock Grid.Column="2" Text="Car" FontSize="10" VerticalAlignment="Center" />
                                                        <TextBox Grid.Column="3" Text="{Binding SessionMetadataCar, Mode=TwoWay}" FontSize="10" MinHeight="24" />
                                                    </Grid>
                                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="4">
                                                        <TextBlock Text="Track ID" FontSize="10" VerticalAlignment="Center" />
                                                        <TextBox Grid.Column="1" Text="{Binding SessionMetadataTrackId, Mode=TwoWay}" Watermark="SimHub trackId" FontSize="10" MinHeight="24" />
                                                    </Grid>
                                                    <Button Content="Save Metadata" Command="{Binding SaveSessionMetadataCommand}" Padding="6,2" FontSize="10" />
                                                </StackPanel>
                                            </Expander>
                                        </StackPanel>
                                    </Expander>

                                    <!-- Preload indicator -->
                                    <ProgressBar Classes="atlas-progress" Height="3" IsIndeterminate="{Binding IsPreloading}" IsVisible="{Binding IsPreloading}" />
                                </StackPanel>
                            </Border>
                            </ScrollViewer>
                        </Grid>
                    </Grid>

                    <!-- Note about ScottPlot -->
                    <Border Grid.Row="2" Background="{DynamicResource BrushInfo}" CornerRadius="4" Padding="12" IsVisible="False">
                        <StackPanel Spacing="4">
                            <TextBlock Text="ðŸ“Š Telemetry Waveforms" FontWeight="Bold" FontSize="12" />
                            <TextBlock TextWrapping="Wrap" FontSize="11">
                                Scroll to zoom and drag to pan.
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </Grid>
            </TabItem>

            <!-- Tab 3: Strategy -->
            <TabItem Header="ðŸŽ¯ STRATEGY">
                <ScrollViewer>
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" Margin="16" RowSpacing="16">
                        <TextBlock Grid.Row="0" Classes="section-header" Text="RACE STRATEGY &amp; PIT PLANNING" />
                        
                        <!-- Current Stint Status -->
                        <Grid Grid.Row="1" ColumnDefinitions="*,*,*" ColumnSpacing="16">
                            <Border Classes="atlas-panel">
                                <StackPanel Spacing="8">
                                    <TextBlock Classes="data-label" Text="FUEL REMAINING" />
                                    <ProgressBar Value="{Binding Strategy.CurrentStintFuelPercentage}" Maximum="100" 
                                                Classes="atlas-progress" Height="12" Foreground="{DynamicResource BrushWarning}" />
                                    <TextBlock Text="{Binding Strategy.CurrentStintFuelPercentage, StringFormat={}{0:0}%}" FontSize="20" FontWeight="Bold" />
                                    <TextBlock Text="{Binding Strategy.StintLap, StringFormat={}Lap {0} of stint}" FontSize="12" Foreground="{DynamicResource BrushTextSecondary}" />
                                </StackPanel>
                            </Border>
                            <Border Classes="atlas-panel" Grid.Column="1">
                                <StackPanel Spacing="8">
                                    <TextBlock Classes="data-label" Text="TIRE WEAR" />
                                    <ProgressBar Value="{Binding Strategy.CurrentStintTireWear}" Maximum="100" 
                                                Classes="atlas-progress" Height="12" Foreground="{DynamicResource BrushSuccess}" />
                                    <TextBlock Text="{Binding Strategy.CurrentStintTireWear, StringFormat={}{0:0}%}" FontSize="20" FontWeight="Bold" />
                                    <TextBlock Text="Within optimal range" FontSize="12" Foreground="{DynamicResource BrushSuccess}"
                                               IsVisible="{Binding Strategy.HasTelemetryData}" />
                                    <TextBlock Text="Awaiting telemetry data" FontSize="12" Foreground="{DynamicResource BrushTextSecondary}"
                                               IsVisible="{Binding Strategy.HasNoTelemetryData}" />
                                </StackPanel>
                            </Border>
                            <Border Classes="atlas-panel" Grid.Column="2">
                                <StackPanel Spacing="8">
                                    <TextBlock Classes="data-label" Text="PIT WINDOW" />
                                    <StackPanel IsVisible="{Binding Strategy.HasTelemetryData}">
                                        <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                            <TextBlock Text="LAP" FontSize="12" Foreground="{DynamicResource BrushTextSecondary}" VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding Strategy.OptimalPitLapStart}" FontSize="24" FontWeight="Bold" Foreground="{DynamicResource BrushSuccess}" />
                                            <TextBlock Text="â€“" FontSize="20" Foreground="{DynamicResource BrushTextSecondary}" VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding Strategy.OptimalPitLapEnd}" FontSize="24" FontWeight="Bold" Foreground="{DynamicResource BrushSuccess}" />
                                        </StackPanel>
                                        <TextBlock Text="{Binding Strategy.NextPitLap, StringFormat={}Recommended: Lap {0}}" FontSize="12" HorizontalAlignment="Center" Foreground="{DynamicResource BrushWarning}" />
                                    </StackPanel>
                                    <TextBlock Text="Awaiting telemetry data" FontSize="12" HorizontalAlignment="Center" Foreground="{DynamicResource BrushTextSecondary}"
                                               IsVisible="{Binding Strategy.HasNoTelemetryData}" />
                                </StackPanel>
                            </Border>
                        </Grid>

                        <!-- Strategy Timeline -->
                        <Border Grid.Row="2" Classes="atlas-panel" MinHeight="140">
                            <Grid RowDefinitions="Auto,*,Auto">
                                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="16" Margin="8">
                                    <TextBlock Classes="section-header" Text="RACE TIMELINE" />
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="Current: Lap" VerticalAlignment="Center" Foreground="{DynamicResource BrushTextSecondary}" />
                                        <TextBlock Text="{Binding Strategy.CurrentLap}" FontWeight="Bold" FontSize="16" VerticalAlignment="Center" />
                                        <TextBlock Text="/" FontSize="16" Foreground="{DynamicResource BrushTextSecondary}" VerticalAlignment="Center" />
                                        <TextBlock Text="{Binding Strategy.TotalRaceLaps}" FontSize="16" Foreground="{DynamicResource BrushTextSecondary}" VerticalAlignment="Center" />
                                    </StackPanel>
                                </StackPanel>
                                <Border Grid.Row="1" Background="#0D0D0D" Margin="8,4" CornerRadius="4" Padding="20">
                                    <StackPanel Spacing="12" VerticalAlignment="Center">
                                        <TextBlock Text="â¬¤â”€â”€â”€â”€â– â”€â”€â”€â”€â¬¤" FontSize="32" HorizontalAlignment="Center" Foreground="#3A3A3A" />
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="24">
                                            <TextBlock Text="Start" FontSize="11" Foreground="{DynamicResource BrushTextSecondary}" />
                                            <TextBlock Text="{Binding Strategy.NextPitLap, StringFormat={}Pit Lap {0}}" FontSize="14" FontWeight="Bold" Foreground="{DynamicResource BrushWarning}" />
                                            <TextBlock Text="Finish" FontSize="11" Foreground="{DynamicResource BrushTextSecondary}" />
                                        </StackPanel>
                                        <TextBlock Text="Timeline visualization with pit markers" HorizontalAlignment="Center" FontSize="11" Foreground="#4A4A4A" />
                                    </StackPanel>
                                </Border>
                                <Grid Grid.Row="2" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8" Margin="8">
                                    <TextBlock Grid.Column="0" Text="{Binding Strategy.RecommendedAction}" FontSize="12" VerticalAlignment="Center" Foreground="{DynamicResource BrushTextSecondary}" />
                                    <TextBlock Grid.Column="1" Text="{Binding Strategy.StrategyConfidence, StringFormat={}Confidence: {0:P0}}" FontSize="12" VerticalAlignment="Center" />
                                    <Button Grid.Column="2" Content="Override Strategy" Command="{Binding Strategy.OverrideStrategyCommand}" Padding="8,4" />
                                </Grid>
                            </Grid>
                        </Border>

                        <!-- Alternative Strategies -->
                        <Border Grid.Row="3" Classes="atlas-panel">
                            <StackPanel Spacing="12">
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <TextBlock Classes="section-header" Text="ALTERNATIVE STRATEGIES" VerticalAlignment="Center" />
                                    <Button Content="{Binding Strategy.FuelSaveModeActive, Converter={StaticResource BoolToTextConverter}, ConverterParameter=Fuel Save: ON|Fuel Save: OFF}"
                                           Command="{Binding Strategy.ToggleFuelSaveModeCommand}" Padding="10,6" VerticalAlignment="Center" />
                                </StackPanel>
                                <ItemsControl ItemsSource="{Binding Strategy.AlternativeStrategies}" IsVisible="{Binding Strategy.HasAlternativeStrategies}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#1A1A1A" Padding="14" Margin="0,6" CornerRadius="6" 
                                                   BorderBrush="#2A2A2A" BorderThickness="1">
                                                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                                                    <TextBlock Grid.Column="0" Text="â—" FontSize="32" Foreground="{DynamicResource BrushInfo}" VerticalAlignment="Center" Margin="0,0,16,0" />
                                                    <StackPanel Grid.Column="1" Spacing="6">
                                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="17" />
                                                        <TextBlock Text="{Binding Description}" Foreground="{DynamicResource BrushTextSecondary}" FontSize="13" TextWrapping="Wrap" />
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="2" Spacing="4" Margin="20,0" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Confidence, StringFormat={}{0:0.1}% confidence}" FontSize="13" HorizontalAlignment="Right" />
                                                        <TextBlock Text="{Binding EstimatedFinishPosition, StringFormat={}Est. P{0}}" FontSize="12" Foreground="{DynamicResource BrushTextSecondary}" HorizontalAlignment="Right" />
                                                    </StackPanel>
                                                    <Button Grid.Column="3" Content="Select" Padding="14,8" VerticalAlignment="Center" FontWeight="Bold"
                                                           Command="{Binding $parent[ItemsControl].((vm:MainWindowViewModel)DataContext).Strategy.SelectAlternativeStrategyCommand}"
                                                           CommandParameter="{Binding}" />
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <TextBlock Text="No alternative strategies available." FontSize="12"
                                           Foreground="{DynamicResource BrushTextSecondary}"
                                           IsVisible="{Binding Strategy.HasNoAlternativeStrategies}" />
                            </StackPanel>
                        </Border>

                        <!-- Competitor Strategies -->
                        <Border Grid.Row="4" Classes="atlas-panel">
                            <Grid RowDefinitions="Auto,Auto">
                                <TextBlock Grid.Row="0" Classes="section-header" Text="COMPETITOR STRATEGIES" Margin="8,8,8,12" />
                                <DataGrid Grid.Row="1" ItemsSource="{Binding Strategy.CompetitorStrategies}" 
                                         AutoGenerateColumns="False" IsReadOnly="True" 
                                         GridLinesVisibility="Horizontal" Background="#0D0D0D" 
                                         HeadersVisibility="Column" CanUserReorderColumns="False"
                                         CanUserResizeColumns="True" CanUserSortColumns="True"
                                         MaxHeight="250" Margin="8,0,8,8">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Pos" Binding="{Binding Position}" Width="60" />
                                        <DataGridTextColumn Header="Car #" Binding="{Binding CarNumber}" Width="85" />
                                        <DataGridTextColumn Header="Driver" Binding="{Binding Driver}" Width="*" />
                                        <DataGridTextColumn Header="Last Pit" Binding="{Binding LastPitLap, StringFormat={}L{0}}" Width="90" />
                                        <DataGridTextColumn Header="Next Pit" Binding="{Binding EstimatedNextPit, StringFormat={}~L{0}}" Width="95" />
                                        <DataGridTextColumn Header="Strategy" Binding="{Binding StrategyType}" Width="120" />
                                    </DataGrid.Columns>
                                </DataGrid>
                                <TextBlock Grid.Row="1" Text="No competitor strategies available." FontSize="12"
                                           Foreground="{DynamicResource BrushTextSecondary}" Margin="8,0,8,8"
                                           IsVisible="{Binding Strategy.HasNoCompetitorStrategies}" />
                            </Grid>
                        </Border>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- Tab 4: AI Engineer -->
            <TabItem Header="ðŸ¤– AI ENGINEER">
                <Grid RowDefinitions="Auto,Auto,Auto,*,Auto,Auto" Margin="16" RowSpacing="12">
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="12">
                        <TextBlock Classes="section-header" Text="AI RACE ENGINEER" VerticalAlignment="Center" />
                        <Button Content="Clear History" Command="{Binding AiAssistant.ClearHistoryCommand}" Padding="8,4" VerticalAlignment="Center" />
                    </StackPanel>

                    <Border Grid.Row="1" Background="#141414" CornerRadius="4" Padding="8"
                           IsVisible="{Binding AiAssistant.HasStatus}">
                        <StackPanel Orientation="Horizontal" Spacing="16">
                            <TextBlock Text="{Binding AiAssistant.StatusMessage}" FontSize="12"
                                      Foreground="{DynamicResource BrushInfo}" />
                            <TextBlock Text="{Binding Settings.LlmStatusSummary}" FontSize="12"
                                      Foreground="{DynamicResource BrushTextSecondary}" />
                        </StackPanel>
                    </Border>

                    <!-- Quick Query Buttons -->
                    <Border Grid.Row="2" Classes="atlas-panel" Padding="12">
                        <StackPanel Spacing="8">
                            <TextBlock Text="QUICK QUERIES" FontSize="12" FontWeight="Bold" Foreground="{DynamicResource BrushTextSecondary}" />
                            <WrapPanel>
                                <Button Content="ðŸ”‹ Fuel Status?" Command="{Binding AiAssistant.SendQuickQueryCommand}" CommandParameter="How much fuel do I have left?" Margin="0,0,8,8" Padding="10,6" />
                                <Button Content="ðŸ Pit Strategy?" Command="{Binding AiAssistant.SendQuickQueryCommand}" CommandParameter="When should I pit?" Margin="0,0,8,8" Padding="10,6" />
                                <Button Content="ðŸŒ¡ï¸ Tire Temps?" Command="{Binding AiAssistant.SendQuickQueryCommand}" CommandParameter="Are my tire temperatures optimal?" Margin="0,0,8,8" Padding="10,6" />
                                <Button Content="â±ï¸ Pace Delta?" Command="{Binding AiAssistant.SendQuickQueryCommand}" CommandParameter="How is my lap time compared to the leader?" Margin="0,0,8,8" Padding="10,6" />
                                <Button Content="âš ï¸ Issues?" Command="{Binding AiAssistant.SendQuickQueryCommand}" CommandParameter="Are there any critical issues I should know about?" Margin="0,0,8,8" Padding="10,6" />
                            </WrapPanel>
                        </StackPanel>
                    </Border>
                    
                    <!-- Chat History -->
                    <ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding AiAssistant.Messages}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,0,0,12" MaxWidth="700"
                                           HorizontalAlignment="{Binding IsUserMessage, Converter={StaticResource BoolToAlignmentUserConverter}}">
                                        <Border Padding="14" CornerRadius="8"
                                               Background="{Binding IsUserMessage, Converter={StaticResource BoolToMessageBackgroundConverter}}"
                                               BorderBrush="{Binding IsUserMessage, Converter={StaticResource BoolToMessageBorderConverter}}"
                                               BorderThickness="1">
                                            <StackPanel Spacing="10">
                                                <!-- Message Header -->
                                                <Grid ColumnDefinitions="Auto,*,Auto">
                                                    <TextBlock Grid.Column="0" Text="{Binding Role}" FontWeight="Bold" FontSize="13" 
                                                              Foreground="{Binding IsUserMessage, Converter={StaticResource BoolToRoleColorConverter}}" />
                                                    <TextBlock Grid.Column="1" Text="{Binding DisplayTimestamp}" FontSize="11" Margin="8,0,0,0"
                                                              Foreground="{DynamicResource BrushTextSecondary}" VerticalAlignment="Center" />
                                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6" IsVisible="{Binding IsAssistantMessage}">
                                                        <TextBlock Text="{Binding DisplaySource}" FontSize="11" 
                                                                  Foreground="{DynamicResource BrushSuccess}" VerticalAlignment="Center" />
                                                        <TextBlock Text="{Binding ConfidenceDisplay}" FontSize="11" 
                                                                  Foreground="{DynamicResource BrushInfo}" VerticalAlignment="Center"
                                                                  IsVisible="{Binding HasConfidence}" />
                                                    </StackPanel>
                                                </Grid>
                                                
                                                <!-- Message Text -->
                                                <TextBlock Text="{Binding Text}" TextWrapping="Wrap" FontSize="14" LineHeight="20" />
                                                
                                                <!-- Context Expander -->
                                                <Expander Header="ðŸ“Š Race Context" IsVisible="{Binding HasContext}" Margin="0,4,0,0">
                                                    <Border Background="#0D0D0D" Padding="10" CornerRadius="4" Margin="0,4,0,0">
                                                        <TextBlock Text="{Binding Context}" FontFamily="Cascadia Mono,Consolas" FontSize="11" 
                                                                  Foreground="#888888" TextWrapping="Wrap" />
                                                    </Border>
                                                </Expander>
                                            </StackPanel>
                                        </Border>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Processing Indicator -->
                          <Border Grid.Row="4" Background="{DynamicResource BrushInfo}" CornerRadius="4" Padding="10" 
                           IsVisible="{Binding AiAssistant.IsProcessing}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="â³" FontSize="16" />
                            <TextBlock Text="Processing your query..." FontSize="13" VerticalAlignment="Center" />
                        </StackPanel>
                    </Border>

                    <!-- Input Area -->
                    <Grid Grid.Row="5" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                        <TextBox Grid.Column="0" Text="{Binding AiAssistant.InputText, Mode=TwoWay}" 
                                Watermark="Ask the race engineer anything..." Height="44" FontSize="14"
                                IsEnabled="{Binding !AiAssistant.IsProcessing}" />
                        <Button Grid.Column="1" Content="ðŸŽ¤" Width="44" Height="44" ToolTip.Tip="Voice Input (Coming Soon)" 
                               IsEnabled="False" Opacity="0.5" />
                        <Button Grid.Column="2" Content="Send" Classes="atlas-button-primary" Height="44" Padding="20,0"
                               Command="{Binding AiAssistant.SendQueryCommand}" 
                               IsEnabled="{Binding !AiAssistant.IsProcessing}" />
                    </Grid>
                </Grid>
            </TabItem>

            <!-- Tab 5: Settings -->
            <TabItem Header="âš™ï¸ SETTINGS">
                <ScrollViewer>
                    <Grid RowDefinitions="Auto,*" Margin="16" RowSpacing="16">
                        <TextBlock Grid.Row="0" Classes="section-header" Text="AGENT CONFIGURATION" />
                        
                        <Grid Grid.Row="1" ColumnDefinitions="*,*" ColumnSpacing="24" RowSpacing="12">
                            <!-- Local LLM Settings -->
                            <StackPanel Grid.Column="0" Spacing="12">
                                <Border Classes="atlas-panel">
                                    <StackPanel Spacing="10">
                                        <TextBlock Classes="data-label" Text="LOCAL LLM SETTINGS" FontSize="14" FontWeight="Bold" />
                                        <CheckBox Content="Enable LLM" IsChecked="{Binding Settings.EnableLlm}" />
                                        <CheckBox Content="Require pit for LLM" IsChecked="{Binding Settings.RequirePitForLlm}" />
                                        
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="Provider:" VerticalAlignment="Center" Width="100" />
                                            <ComboBox Width="200" ItemsSource="{Binding Settings.LlmProviders}" 
                                                     SelectedItem="{Binding Settings.LlmProvider}" />
                                        </StackPanel>
                                        
                                        <TextBox Watermark="LLM Endpoint" Text="{Binding Settings.LlmEndpoint, Mode=TwoWay}" />
                                        <TextBox Watermark="LLM Model" Text="{Binding Settings.LlmModel, Mode=TwoWay}" />
                                        <TextBox Watermark="Timeout (ms)" Text="{Binding Settings.LlmTimeoutMs, Mode=TwoWay}" />
                                        
                                        <CheckBox Content="Enable discovery" IsChecked="{Binding Settings.EnableLlmDiscovery}" />
                                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                                            <TextBox Grid.Column="0" Watermark="Discovery Port" Text="{Binding Settings.LlmDiscoveryPort, Mode=TwoWay}" />
                                            <TextBox Grid.Column="1" Watermark="Concurrency" Text="{Binding Settings.LlmDiscoveryMaxConcurrency, Mode=TwoWay}" />
                                        </Grid>
                                        <TextBox Watermark="Subnet Prefix" Text="{Binding Settings.LlmDiscoverySubnetPrefix, Mode=TwoWay}" />
                                        
                                        <Button Content="Discover Endpoints" Command="{Binding Settings.DiscoverLlmEndpointsCommand}" 
                                               IsEnabled="{Binding !Settings.IsDiscovering}" />
                                        
                                        <!-- Discovered Endpoints List -->
                                        <Border Background="#1A1A1A" CornerRadius="4" Padding="10" Margin="0,8,0,0"
                                               IsVisible="{Binding Settings.DiscoveredEndpoints.Count}">
                                            <StackPanel Spacing="8">
                                                <TextBlock Text="DISCOVERED ENDPOINTS" FontSize="12" FontWeight="Bold" 
                                                          Foreground="{DynamicResource BrushSuccess}" />
                                                <ScrollViewer MaxHeight="200">
                                                    <ItemsControl ItemsSource="{Binding Settings.DiscoveredEndpoints}">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <Border Background="#0D0D0D" Padding="8" Margin="0,2" CornerRadius="4"
                                                                       BorderBrush="#2A2A2A" BorderThickness="1">
                                                                    <Grid ColumnDefinitions="*,Auto">
                                                                        <TextBlock Grid.Column="0" Text="{Binding}" FontFamily="Cascadia Mono,Consolas" 
                                                                                  FontSize="12" VerticalAlignment="Center" />
                                                                        <Button Grid.Column="1" Content="Use" Padding="8,4" 
                                                                               Command="{Binding $parent[ItemsControl].((vm:MainWindowViewModel)DataContext).Settings.SelectEndpointCommand}"
                                                                               CommandParameter="{Binding}" />
                                                                    </Grid>
                                                                </Border>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </ScrollViewer>
                                            </StackPanel>
                                        </Border>
                                        
                                        <!-- Discovery Status -->
                                        <Border Background="{DynamicResource BrushInfo}" CornerRadius="4" Padding="8" 
                                               IsVisible="{Binding Settings.IsDiscovering}">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="â³" FontSize="14" />
                                                <TextBlock Text="Scanning network..." FontSize="12" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>

                            </StackPanel>

                            <!-- Cloud Provider Settings -->
                            <StackPanel Grid.Column="1" Spacing="12">
                                <Border Classes="atlas-panel">
                                    <StackPanel Spacing="10">
                                        <TextBlock Classes="data-label" Text="CLOUD PROVIDERS" FontSize="14" FontWeight="Bold" />
                                        
                                        <TextBlock Text="OpenAI" FontSize="16" FontWeight="Bold" Margin="0,8,0,0" />
                                        <TextBox Watermark="OpenAI Endpoint" Text="{Binding Settings.OpenAiEndpoint, Mode=TwoWay}" />
                                        <TextBox Watermark="OpenAI Model" Text="{Binding Settings.OpenAiModel, Mode=TwoWay}" />
                                        <TextBox Watermark="OpenAI API Key" Text="{Binding Settings.OpenAiApiKey, Mode=TwoWay}" PasswordChar="*" />
                                        <TextBlock Text="âœ“ Configured" IsVisible="{Binding Settings.OpenAiApiKeyConfigured}" 
                                                  Foreground="{DynamicResource BrushSuccess}" />

                                        <TextBlock Text="Anthropic" FontSize="16" FontWeight="Bold" Margin="0,16,0,0" />
                                        <TextBox Watermark="Anthropic Endpoint" Text="{Binding Settings.AnthropicEndpoint, Mode=TwoWay}" />
                                        <TextBox Watermark="Anthropic Model" Text="{Binding Settings.AnthropicModel, Mode=TwoWay}" />
                                        <TextBox Watermark="Anthropic API Key" Text="{Binding Settings.AnthropicApiKey, Mode=TwoWay}" PasswordChar="*" />
                                        <TextBlock Text="âœ“ Configured" IsVisible="{Binding Settings.AnthropicApiKeyConfigured}" 
                                                  Foreground="{DynamicResource BrushSuccess}" />
                                    </StackPanel>
                                </Border>
                                
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <Button Content="Reload Settings" Command="{Binding Settings.LoadSettingsCommand}" />
                                    <Button Content="Save Settings" Classes="atlas-button-primary" Command="{Binding Settings.SaveSettingsCommand}" />
                                    <Button Content="Restart Stack" Command="{Binding Settings.RestartStackCommand}"
                                            IsEnabled="{Binding !Settings.IsRestarting}" />
                                </StackPanel>
                                
                                <TextBlock Text="{Binding Settings.StatusMessage}" Foreground="{DynamicResource BrushInfo}" 
                                          IsVisible="{Binding Settings.StatusMessage}" Margin="0,8,0,0" />

                                <Border Classes="atlas-panel" Margin="0,12,0,0">
                                    <StackPanel Spacing="6">
                                        <TextBlock Classes="data-label" Text="ATTRIBUTION" FontSize="12" FontWeight="Bold" />
                                        <TextBlock TextWrapping="Wrap" FontSize="11">
                                            Track data: Lovely Track Data (Â© 2025 Lovely Sim Racing, CC BY-NC-SA 4.0) - https://github.com/Lovely-Sim-Racing/lovely-track-data
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </Grid>
</Window>
